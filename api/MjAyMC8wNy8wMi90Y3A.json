{"title":"websocket学习笔记","date":"2020-07-02T04:03:46.000Z","date_formatted":{"ll":"Jul 2, 2020","L":"07/02/2020","MM-DD":"07-02"},"thumbnail":"2020/07/02/tcp/./banner.png","link":"2020/07/02/tcp","tags":["websocket"],"categories":["网络通信"],"updated":"2021-01-21T05:54:47.458Z","content":"<h2 id=\"简介\">简介<a title=\"#简介\" href=\"#简介\"></a></h2>\n<p>TCP是整个TCP/IP协议族中最重要的协议之一，它在IP协议提供的不可靠数据服务的基础上，采用了重发技术，为应用程序提供了一个可靠的、面向连接的、全双工的数据传输服务。TCP协议一般用于传输数据量比较少，且对可靠性要求高的场合。<a href=\"#refer-anchor-1\"><sup>1</sup></a>。</p>\n<p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。另外，WebSocket在TCP之上启用消息流。单独的TCP处理字节流时没有消息的固有概念。在使用WebSocket之前，可以使用Comet通道实现端口80全双工通信。但是，Comet的实现并非易事，并且由于TCP握手和HTTP标头开销，对于小消息它效率不高。WebSocket协议旨在解决这些问题而不损害Web的安全性假设。使用浏览器开发人员工具，开发人员可以检查WebSocket握手以及WebSocket框架<a href=\"#refer-anchor-2\"><sup>2</sup></a>。</p>\n<h2 id=\"握手协议\">握手协议<a title=\"#握手协议\" href=\"#握手协议\"></a></h2>\n<p>为了建立WebSocket连接，客户端发送一个WebSocket握手请求，服务器将为其返回WebSocket握手响应，如下例所示。</p>\n<p>客户端请求：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET&#x2F;chat  HTTP&#x2F;1.1 </span><br><span class=\"line\">host: server.example.com </span><br><span class=\"line\">Upgrade: websocket </span><br><span class=\"line\">Connection: Upgrade</span><br><span class=\"line\">Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw&#x3D;&#x3D;</span><br><span class=\"line\">Sec-WebSocket-Protocol: chat, superchat </span><br><span class=\"line\">Sec-WebSocket-Version: 13 </span><br><span class=\"line\">Origin: http:&#x2F;&#x2F;example.com</span><br></pre></td></tr></table></figure>\n<p>服务器响应：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP&#x2F;1.1  101  Switching Protocols</span><br><span class=\"line\">Upgrade: websocket </span><br><span class=\"line\">Connection: Upgrade</span><br><span class=\"line\">Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk&#x3D; </span><br><span class=\"line\">Sec-WebSocket-Protocol: chat</span><br></pre></td></tr></table></figure>\n<p>握手始于HTTP请求/响应，允许服务器在同一端口上处理HTTP连接以及WebSocket连接。建立连接后，通信将切换到不符合HTTP协议的双向二进制协议。</p>\n<p>除了Upgrade标头之外，客户端还会发送一个Sec-WebSocket-Key标头，该标头包含base64编码的随机字节，服务器会在标头中使用密钥的哈希值进行回复Sec-WebSocket-Accept。这是为了防止缓存 代理重新发送以前的WebSocket会话，并且不提供任何身份验证，隐私或完整性。哈希函数将固定字符串258EAFA5-E914-47DA-95CA-C5AB0DC85B11（UUID）附加到Sec-WebSocket-Key标头中的值（不会从base64解码）中，应用SHA-1哈希函数，并使用base64对结果进行编码。</p>\n<p>建立连接后，客户端和服务器即可以全双工模式来回发送WebSocket数据或文本框架。数据被最小限度地构架，并带有一个小的标头，后跟有效负载。WebSocket传输被描述为“消息”，其中单个消息可以有选择地拆分为多个数据帧。这可以允许在初始数据可用但消息的完整长度未知的情况下发送消息（它发送一个数据帧一个接一个，直到到达末尾并用FIN位标记）。通过扩展协议，它还可以用于同时多路复用多个流（例如，避免对单个大型有效负载独占使用套接字）。</p>\n<h2 id=\"实践——简易聊天室\">实践——简易聊天室<a title=\"#实践——简易聊天室\" href=\"#实践——简易聊天室\"></a></h2>\n<h3 id=\"需求\">需求<a title=\"#需求\" href=\"#需求\"></a></h3>\n<p>搭建一个简易聊天室。</p>\n<ol>\n<li>浏览器网页通过websocket和后台建立连接。</li>\n<li>后台存储session并存储连接时带来的userId和session的映射关系。</li>\n<li>实现向特定id的用户发送消息。</li>\n</ol>\n<h3 id=\"服务端\">服务端<a title=\"#服务端\" href=\"#服务端\"></a></h3>\n<p>Maven中引用spring-boot-starter-websocket:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>websocket配置类:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSocketConfig</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ServerEndpointExporter <span class=\"title\">serverEndpointExporter</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ServerEndpointExporter();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>实现websocket组件:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ServerEndpoint</span>(<span class=\"string\">\"/wsMessage/&#123;userId&#125;\"</span>)</span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebSocketServer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 用于存放用户id和session映射关系的Map</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Map&lt;String,Session&gt; sessionMap = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 连接建立成功处理</span></span><br><span class=\"line\"><span class=\"comment\">     **/</span></span><br><span class=\"line\">    <span class=\"meta\">@OnOpen</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onOpen</span><span class=\"params\">(Session session,@PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 存储用户和session映射关系 如果已存在 关闭之前的连接</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sessionMap.containsKey(userId)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                sessionMap.get(userId).close();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        sessionMap.put(userId, session);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            BaseMsg msg = <span class=\"keyword\">new</span> BaseMsg(<span class=\"string\">\"notice\"</span>, <span class=\"string\">\"server\"</span>, userId, <span class=\"string\">\"上线成功\"</span>);</span><br><span class=\"line\">            Gson gson = <span class=\"keyword\">new</span> Gson();</span><br><span class=\"line\">            String msgStr = gson.toJson(msg);</span><br><span class=\"line\">            session.getBasicRemote().sendText(msgStr);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">\"用户:\"</span>+userId+<span class=\"string\">\",上线失败\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 收到客户端消息处理</span></span><br><span class=\"line\"><span class=\"comment\">     **/</span></span><br><span class=\"line\">    <span class=\"meta\">@OnMessage</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onMessage</span><span class=\"params\">(String message, Session session, @PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(StringUtils.isNotBlank(message))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Gson gson = <span class=\"keyword\">new</span> Gson();</span><br><span class=\"line\">                BaseMsg clientMsg = gson.fromJson(message, BaseMsg<span class=\"class\">.<span class=\"keyword\">class</span>)</span>;</span><br><span class=\"line\">                String target = clientMsg.getTarget();</span><br><span class=\"line\">                String type = clientMsg.getType();</span><br><span class=\"line\">                String note = clientMsg.getMsg();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">switch</span> (type) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">case</span> <span class=\"string\">\"sendMsg\"</span>: &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// 发送信息到指定用户</span></span><br><span class=\"line\">                        BaseMsg msg = <span class=\"keyword\">new</span> BaseMsg(<span class=\"string\">\"msg\"</span>, userId, target, note);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span>( StringUtils.isNotBlank(target) &amp;&amp; sessionMap.containsKey(target))&#123;</span><br><span class=\"line\">                            String msgStr = gson.toJson(msg);</span><br><span class=\"line\">                            sessionMap.get(target).getBasicRemote().sendText(msgStr);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            System.out.println(<span class=\"string\">\"目标用户\"</span> + target + <span class=\"string\">\"未上线\"</span>);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"keyword\">default</span>: &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;<span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 连接关闭处理</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnClose</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onClose</span><span class=\"params\">( @PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(sessionMap.containsKey(userId))&#123;</span><br><span class=\"line\">            sessionMap.remove(userId);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 连接错误处理</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@OnError</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onError</span><span class=\"params\">(Session session, Throwable error, @PathParam(<span class=\"string\">\"userId\"</span>)</span> String userId) </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">\"用户错误:\"</span>+userId+<span class=\"string\">\",原因:\"</span>+error.getMessage());</span><br><span class=\"line\">        error.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"前端\">前端<a title=\"#前端\" href=\"#前端\"></a></h3>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"ws\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"safeBox\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-card</span> <span class=\"attr\">class</span>=<span class=\"string\">\"box-card\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">v-for</span>=<span class=\"string\">\"msg in messageList\"</span> <span class=\"attr\">:key</span>=<span class=\"string\">\"msg\"</span> <span class=\"attr\">class</span>=<span class=\"string\">\"text item\"</span>&gt;</span></span><br><span class=\"line\">          &#123;&#123;'消息 ' + msg &#125;&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-card</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-input</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">placeholder</span>=<span class=\"string\">\"请输入内容\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">v-model</span>=<span class=\"string\">\"msg\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">clearable</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"success\"</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"append\"</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"sendMsg()\"</span>&gt;</span>发送<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-input</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">placeholder</span>=<span class=\"string\">\"请输入id\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">v-model</span>=<span class=\"string\">\"client\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">clearable</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">el-button</span> <span class=\"attr\">type</span>=<span class=\"string\">\"success\"</span> <span class=\"attr\">slot</span>=<span class=\"string\">\"append\"</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"wsInit()\"</span>&gt;</span>上线<span class=\"tag\">&lt;/<span class=\"name\">el-button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">el-input</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">placeholder</span>=<span class=\"string\">\"请输入目标id\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">v-model</span>=<span class=\"string\">\"target\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">clearable</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">el-input</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">template</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">  name: <span class=\"string\">'WsTest'</span>,</span></span><br><span class=\"line\">  data () &#123;</span><br><span class=\"line\"><span class=\"actionscript\">    <span class=\"keyword\">return</span> &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">      socket: <span class=\"literal\">null</span>,</span></span><br><span class=\"line\"><span class=\"actionscript\">      msg: <span class=\"string\">''</span>,</span></span><br><span class=\"line\"><span class=\"actionscript\">      client: <span class=\"string\">''</span>,</span></span><br><span class=\"line\"><span class=\"actionscript\">      target: <span class=\"string\">''</span>,</span></span><br><span class=\"line\">      messageList: []</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  methods: &#123;</span><br><span class=\"line\">    sendMsg () &#123;</span><br><span class=\"line\"><span class=\"actionscript\">      <span class=\"keyword\">const</span> param = &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        client: <span class=\"keyword\">this</span>.client,</span></span><br><span class=\"line\"><span class=\"actionscript\">        target: <span class=\"keyword\">this</span>.target,</span></span><br><span class=\"line\"><span class=\"actionscript\">        msg: <span class=\"keyword\">this</span>.msg,</span></span><br><span class=\"line\"><span class=\"actionscript\">        type: <span class=\"string\">'sendMsg'</span></span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.socket.send(<span class=\"built_in\">JSON</span>.stringify(param))</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    wsInit () &#123;</span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">let</span> socketUrl = <span class=\"string\">'ws://localhost:9999/wsMessage/'</span> + <span class=\"keyword\">this</span>.client</span></span><br><span class=\"line\"><span class=\"actionscript\">      <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.socket != <span class=\"literal\">null</span>) &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">this</span>.socket.close()</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">this</span>.socket = <span class=\"literal\">null</span></span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"actionscript\">      <span class=\"keyword\">this</span>.socket = <span class=\"keyword\">new</span> WebSocket(socketUrl)</span></span><br><span class=\"line\"><span class=\"actionscript\">      <span class=\"comment\">// 打开事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.socket.onopen = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">const</span> param = &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">          client: <span class=\"keyword\">this</span>.client,</span></span><br><span class=\"line\"><span class=\"actionscript\">          target: <span class=\"string\">'all'</span>,</span></span><br><span class=\"line\"><span class=\"actionscript\">          msg: <span class=\"keyword\">this</span>.client + <span class=\"string\">'已上线'</span>,</span></span><br><span class=\"line\"><span class=\"actionscript\">          type: <span class=\"string\">'online'</span></span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">this</span>.socket.send(<span class=\"built_in\">JSON</span>.stringify(param))</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"actionscript\">      <span class=\"comment\">// 获得消息事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.socket.onmessage = <span class=\"function\">(<span class=\"params\">msg</span>) =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">        <span class=\"keyword\">if</span> (msg.data != <span class=\"literal\">null</span>) &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">          <span class=\"keyword\">const</span> message = <span class=\"built_in\">JSON</span>.parse(msg.data)</span></span><br><span class=\"line\"><span class=\"actionscript\">          <span class=\"keyword\">if</span> (message.type === <span class=\"string\">'notice'</span>) &#123;</span></span><br><span class=\"line\">            alert(message.msg)</span><br><span class=\"line\"><span class=\"actionscript\">          &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (message.type === <span class=\"string\">'msg'</span>) &#123;</span></span><br><span class=\"line\"><span class=\"actionscript\">            <span class=\"keyword\">this</span>.messageList.push(message.client + <span class=\"string\">':'</span> + message.msg)</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"actionscript\">      <span class=\"comment\">// 关闭事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.socket.onclose = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'websocket已关闭'</span>)</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"actionscript\">      <span class=\"comment\">// 发生了错误事件</span></span></span><br><span class=\"line\"><span class=\"javascript\">      <span class=\"keyword\">this</span>.socket.onerror = <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"built_in\">console</span>.log(<span class=\"string\">'websocket发生了错误'</span>)</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"效果演示\">效果演示<a title=\"#效果演示\" href=\"#效果演示\"></a></h3>\n<p>两个用户上线：</p>\n<p><img src=\"/2020/07/02/tcp/pic1.png\" alt class=\"φcx\"></p>\n<p>用户1给用户2发消息：</p>\n<p><img src=\"/2020/07/02/tcp/pic2.png\" alt class=\"φcx\"></p>\n<p>用户2给用户1发消息：</p>\n<p><img src=\"/2020/07/02/tcp/pic3.png\" alt class=\"φcx\"></p>\n<h2 id=\"参考\">参考<a title=\"#参考\" href=\"#参考\"></a></h2>\n<div id=\"refer-anchor-1\"></div>\n<p>- [1] <a href=\"https://read.douban.com/ebook/58733643/\" target=\"_blank\">《系统架构设计师教程（第4版）》 — 希赛教育软考学院</a></p>\n<div id=\"refer-anchor-2\"></div>\n<p>- [2] <a href=\"https://en.wikipedia.org/wiki/WebSocket\" target=\"_blank\">维基百科</a></p>\n","prev":{"title":"spring cloud学习笔记——服务治理Eureka","link":"2020/07/11/eureka"},"plink":"https://lxjf0y.coding-pages.com/2020/07/02/tcp/","toc":[{"id":"简介","title":"简介","index":"1"},{"id":"握手协议","title":"握手协议","index":"2"},{"id":"实践——简易聊天室","title":"实践——简易聊天室","index":"3","children":[{"id":"需求","title":"需求","index":"3.1"},{"id":"服务端","title":"服务端","index":"3.2"},{"id":"前端","title":"前端","index":"3.3"},{"id":"效果演示","title":"效果演示","index":"3.4"}]},{"id":"参考","title":"参考","index":"4"}],"copyright":{"author":"Gyaku","license":"个人学习笔记，如有不准确的描述，还请见谅。转载请注明出处。","link":"<a href=\"https://lxjf0y.coding-pages.com/2020/07/02/tcp/\" title=\"websocket学习笔记\">https://lxjf0y.coding-pages.com/2020/07/02/tcp/</a>"}}